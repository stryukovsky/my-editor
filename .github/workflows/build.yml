name: Build Neovim Config Package

on:
  push:
    branches: [ pure ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Neovim
      run: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository ppa:neovim-ppa/unstable -y
        sudo apt-get update
        sudo apt-get install -y neovim
        
    - name: Install dependencies (Node.js, Python, etc.)
      run: |
        sudo apt-get install -y nodejs npm python3 python3-pip ripgrep fd-find
        
    - name: Set up config directory
      run: |
        mkdir -p ~/.config/nvim
        cp -r * ~/.config/nvim/ 2>/dev/null || true
        cp -r .* ~/.config/nvim/ 2>/dev/null || true
        
    - name: Install plugins and dependencies
      run: |
        cd ~/.config/nvim
        # Run headless Neovim to install plugins
        nvim --headless "+Lazy! sync" +qa
        
    - name: Install TreeSitter parsers
      run: |
        cd ~/.config/nvim
        nvim --headless -c "TSUpdateSync" -c "qa"
        
    - name: Install Mason LSP servers (optional)
      run: |
        cd ~/.config/nvim
        # Install common LSP servers - customize this list
        nvim --headless -c "MasonInstall lua-language-server pyright typescript-language-server" -c "qa"
      continue-on-error: true
        
    - name: Clean up unnecessary files
      run: |
        cd ~/.config/nvim
        # Remove git directories from plugins
        find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
        # Remove cache files
        rm -rf cache/* 2>/dev/null || true
        # Remove log files
        find . -name "*.log" -delete 2>/dev/null || true
        
    - name: Create archive
      run: |
        cd ~/.config
        tar -czf nvim-config-$(date +%Y%m%d-%H%M%S).tar.gz nvim/
        mv nvim-config-*.tar.gz $GITHUB_WORKSPACE/
        
    - name: Create zip archive (alternative)
      run: |
        cd ~/.config
        zip -r nvim-config-$(date +%Y%m%d-%H%M%S).zip nvim/
        mv nvim-config-*.zip $GITHUB_WORKSPACE/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nvim-config-package
        path: |
          *.tar.gz
          *.zip
        retention-days: 30
        
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.tar.gz
          *.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
